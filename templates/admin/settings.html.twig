{# templates/admin/settings.html.twig #}
{% extends 'base.html.twig' %}
{% block title %}Paramètres admin{% endblock %}

{% block body %}
<div class="container py-4">
  <h1 class="mb-3">Paramètres</h1>

  {{ form_start(form) }}

  {# --- Dropzone Profil --- #}
  <div id="profil-dropzone" class="js-dropzone border rounded p-3 mb-3 d-flex align-items-center gap-3" style="min-height:120px;">
    <img
      class="js-preview"
      src="{{ admin.srcProfil ? asset('uploads/profiles/' ~ admin.srcProfil) : asset('placeholder-avatar.png') }}"
      data-placeholder="{{ asset('placeholder-avatar.png') }}"
      alt=""
      aria-hidden="true"
      style="width:120px;height:120px;object-fit:cover;border-radius:12px;"
    >
    <div class="flex-grow-1">
      <div class="fw-semibold mb-1">Glissez une image de profil ici, ou cliquez.</div>
      <div class="small text-muted">JPEG, PNG, WEBP — 4 Mo max</div>
      <div class="js-filename mt-2 small">
        {% if admin.srcProfil %}Image actuelle : <em>{{ admin.srcProfil }}</em>{% endif %}
      </div>
      <div class="mt-2 d-flex flex-wrap gap-2">
        <button type="button" class="btn btn-outline-secondary btn-sm js-clear">Effacer la sélection</button>
        {% if admin.srcProfil %}
          <div class="form-check">
            <input class="form-check-input js-remove-checkbox" type="checkbox" id="remove_image" name="remove_image">
            <label class="form-check-label" for="remove_image">Supprimer l'image actuelle</label>
          </div>
        {% endif %}
      </div>
    </div>
    <div class="d-none">
      {{ form_widget(form.src_profil, {
        attr: {
          accept: 'image/*',
          class: 'js-file',
          'data-max': 4194304
        }
      }) }}
    </div>
  </div>

  {# --- Dropzone Logo --- #}
  <div id="logo-dropzone" class="js-dropzone border rounded p-3 mb-3 d-flex align-items-center gap-3" style="min-height:120px;">
    <img
      class="js-preview"
      src="{{ admin.srcLogo ? asset('uploads/logos/' ~ admin.srcLogo) : asset('placeholder-logo.png') }}"
      data-placeholder="{{ asset('placeholder-logo.png') }}"
      alt=""
      aria-hidden="true"
      style="width:120px;height:120px;object-fit:contain;border-radius:12px;background:#fff;"
    >
    <div class="flex-grow-1">
      <div class="fw-semibold mb-1">Glissez votre logo ici, ou cliquez.</div>
      <div class="small text-muted">JPEG, PNG, WEBP — 4 Mo max</div>
      <div class="js-filename mt-2 small">
        {% if admin.srcLogo %}Logo actuel : <em>{{ admin.srcLogo }}</em>{% endif %}
      </div>
      <div class="mt-2 d-flex flex-wrap gap-2">
        <button type="button" class="btn btn-outline-secondary btn-sm js-clear">Effacer la sélection</button>
        {% if admin.srcLogo %}
          <div class="form-check">
            <input class="form-check-input js-remove-checkbox" type="checkbox" id="remove_logo" name="remove_logo">
            <label class="form-check-label" for="remove_logo">Supprimer le logo actuel</label>
          </div>
        {% endif %}
      </div>
    </div>
    <div class="d-none">
      {{ form_widget(form.logo, {
        attr: {
          accept: 'image/*',
          class: 'js-file',
          'data-max': 4194304
        }
      }) }}
    </div>
  </div>

  {# --- Champs texte --- #}
  <div class="row g-3">
    <div class="col-12 col-md-6 text-center">
      <div class="mb-3">
        {{ form_label(form.sous_titre, 'Sous-titre', {'label_attr': {'class': 'form-label d-block'}}) }}
        {{ form_widget(form.sous_titre, {'attr': {'class': 'form-control text-center'}}) }}
        {{ form_errors(form.sous_titre) }}
      </div>
    </div>
    <div class="col-12 col-md-6 text-center">
      <div class="mb-3">
        {{ form_label(form.telephone, 'Téléphone', {'label_attr': {'class': 'form-label d-block'}}) }}
        {{ form_widget(form.telephone, {'attr': {'class': 'form-control text-center'}}) }}
        {{ form_errors(form.telephone) }}
      </div>
    </div>
  </div>

  <div class="row g-3">
    <div class="col-12 col-md-6 text-center">
      <div class="mb-3">
        {{ form_label(form.email, 'Email', {'label_attr': {'class': 'form-label d-block'}}) }}
        {{ form_widget(form.email, {'attr': {'class': 'form-control text-center'}}) }}
        {{ form_errors(form.email) }}
      </div>
    </div>
    <div class="col-12 col-md-6 text-center">
      <div class="mb-3">
        {{ form_label(form.adresse, 'Adresse', {'label_attr': {'class': 'form-label d-block'}}) }}
        {{ form_widget(form.adresse, {'attr': {'class': 'form-control text-center'}}) }}
        {{ form_errors(form.adresse) }}
      </div>
    </div>
    <div class="col-12 col-md-6 text-center">
      <div class="mb-3">
        {{ form_label(form.ville, 'Code postal et ville', {'label_attr': {'class': 'form-label d-block'}}) }}
        {{ form_widget(form.ville, {'attr': {'class': 'form-control text-center'}}) }}
        {{ form_errors(form.ville) }}
      </div>
    </div>
  </div>

  <div class="row g-3">
    <div class="col-12 col-md-6 text-center">
      <div class="mb-3">
        {{ form_label(form.supp_info, 'Info supplémentaire', {'label_attr': {'class': 'form-label d-block'}}) }}
        {{ form_widget(form.supp_info, {'attr': {'class': 'form-control text-center'}}) }}
        {{ form_errors(form.supp_info) }}
      </div>
    </div>
    <div class="col-12 col-md-6 text-center">
      <div class="mb-3">
        {{ form_label(form.slogan, 'Phrase accroche', {'label_attr': {'class': 'form-label d-block'}}) }}
        {{ form_widget(form.slogan, {'attr': {'class': 'form-control text-center'}}) }}
        {{ form_errors(form.slogan) }}
      </div>
    </div>
  </div>

  {# =========================
     SERVICES & PHOTOS
     ========================= #}
  <div class="mt-4">
    <div class="d-flex align-items-center justify-content-between mb-2">
      <h2 class="h5 mb-0">Services</h2>
      <button type="button" class="btn btn-outline-primary btn-sm" id="add-service-btn">+ Ajouter un service</button>
    </div>

    {# --- Prototype PHOTO (base) --- #}
    {% set nestedPhotoProto %}
      <div class="col-12 col-md-6 col-lg-4 photo-item">
        <div class="js-dropzone border rounded p-2 d-flex align-items-center gap-2" style="min-height:90px; cursor:pointer;">
          <img
            class="js-preview"
            src="{{ asset('placeholder-image.png') }}"
            data-placeholder="{{ asset('placeholder-image.png') }}"
            alt=""
            aria-hidden="true"
            style="width:72px;height:72px;object-fit:cover;border-radius:10px;"
          >
          <div class="flex-grow-1 small">
            <div class="fw-semibold">Déposez une image, ou cliquez.</div>
            <div class="text-muted">JPEG/PNG/WEBP — 4&nbsp;Mo max</div>
            <div class="js-filename mt-1"></div>
            <div class="mt-2 d-flex gap-2 align-items-center">
              <button type="button" class="btn btn-outline-secondary btn-sm js-add">Ajouter</button>
              <button type="button" class="btn btn-outline-danger btn-sm remove-photo-btn">Supprimer la photo</button>
            </div>
          </div>

          {# IMPORTANT : ce prototype contient DEUX __name__ (service + photo). #}
          {{ form_widget(form.services.vars.prototype.photoServices.vars.prototype.file, {
            attr: {
              accept: 'image/*',
              class: 'js-file',
              style: 'position:absolute;left:-9999px;width:1px;height:1px;opacity:0;',
              'data-max': 4194304
            }
          }) }}
        </div>

        <div class="mt-2">
          <label class="form-label mb-1 small">Description</label>
          {{ form_widget(form.services.vars.prototype.photoServices.vars.prototype.description, {
            attr: { class:'form-control form-control-sm', placeholder:'Description (optionnelle)' }
          }) }}
        </div>
      </div>
    {% endset %}

    {# =========================================================
       FIX CRITIQUE :
       - On NE doit PAS remplacer tous les "__name__" par "__pname__"
       - On remplace uniquement le placeholder de la PHOTO (après photoServices)
       ========================================================= #}
    {% set nestedPhotoProtoFixed = nestedPhotoProto
      |replace({ '][photoServices][__name__][': '][photoServices][__pname__][' })
      |replace({ '[photoServices][__name__]': '[photoServices][__pname__]' })
      |replace({ '_photoServices___name__': '_photoServices___pname__' })
    %}

    {# --- Prototype SERVICE --- #}
    {% set serviceProto %}
      <div class="card mb-3 service-item">
        <div class="card-body">
          <div class="d-flex align-items-center justify-content-between">
            <div class="me-3 flex-grow-1">
              {{ form_row(form.services.vars.prototype.libelle, {
                label: 'Libellé du service',
                attr: { class: 'form-control', placeholder: 'Ex. Chauffe-eau, Sanitaire, ...' }
              }) }}
            </div>
            <button type="button" class="btn btn-outline-danger btn-sm remove-service-btn">Supprimer le service</button>
          </div>

          <div class="mt-3">
            <div class="d-flex align-items-center justify-content-between mb-2">
              <h3 class="h6 mb-0">Photos</h3>
              <button type="button" class="btn btn-outline-secondary btn-sm add-photo-btn">+ Ajouter une photo</button>
            </div>

            <div class="row g-3 photos-collection"
                 data-index="0"
                 data-protoname="__pname__"
                 data-prototype="{{ nestedPhotoProtoFixed|e('html_attr') }}">
            </div>
          </div>
        </div>
      </div>
    {% endset %}

    <div id="services-collection"
         data-index="{{ form.services|length }}"
         data-prototype="{{ serviceProto|e('html_attr') }}">

      {# Services existants #}
      {% for serviceForm in form.services %}
        <div class="card mb-3 service-item">
          <div class="card-body">
            <div class="d-flex align-items-center justify-content-between">
              <div class="me-3 flex-grow-1">
                {{ form_row(serviceForm.libelle, {
                  label: 'Libellé du service',
                  attr: { class: 'form-control', placeholder: 'Ex. Coiffure, Barbe, ...' }
                }) }}
              </div>
              <button type="button" class="btn btn-outline-danger btn-sm remove-service-btn">Supprimer le service</button>
            </div>

            <div class="mt-3">
              <div class="d-flex align-items-center justify-content-between mb-2">
                <h3 class="h6 mb-0">Photos</h3>
                <button type="button" class="btn btn-outline-secondary btn-sm add-photo-btn">+ Ajouter une photo</button>
              </div>

              {% set photoProto %}
                <div class="col-12 col-md-6 col-lg-4 photo-item">
                  <div class="js-dropzone border rounded p-2 d-flex align-items-center gap-2" style="min-height:90px; cursor:pointer;">
                    <img
                      class="js-preview"
                      src="{{ asset('placeholder-image.png') }}"
                      data-placeholder="{{ asset('placeholder-image.png') }}"
                      alt=""
                      aria-hidden="true"
                      style="width:72px;height:72px;object-fit:cover;border-radius:10px;"
                    >
                    <div class="flex-grow-1 small">
                      <div class="fw-semibold">Déposez une image, ou cliquez.</div>
                      <div class="text-muted">JPEG/PNG/WEBP — 4&nbsp;Mo max</div>
                      <div class="js-filename mt-1"></div>
                      <div class="mt-2 d-flex gap-2 align-items-center">
                        <button type="button" class="btn btn-outline-secondary btn-sm js-add">Ajouter</button>
                        <button type="button" class="btn btn-outline-danger btn-sm remove-photo-btn">Supprimer la photo</button>
                      </div>
                    </div>
                    {{ form_widget(serviceForm.photoServices.vars.prototype.file, {
                      attr: {
                        accept: 'image/*',
                        class: 'js-file',
                        style: 'position:absolute;left:-9999px;width:1px;height:1px;opacity:0;',
                        'data-max': 4194304
                      }
                    }) }}
                  </div>
                  <div class="mt-2">
                    <label class="form-label mb-1 small">Description</label>
                    {{ form_widget(serviceForm.photoServices.vars.prototype.description, {
                      attr: { class:'form-control form-control-sm', placeholder:'Description (optionnelle)' }
                    }) }}
                  </div>
                </div>
              {% endset %}

              <div class="row g-3 photos-collection"
                   data-index="{{ serviceForm.photoServices|length }}"
                   data-protoname="__name__"
                   data-prototype="{{ photoProto|e('html_attr') }}">

                {% for photoForm in serviceForm.photoServices %}
                  <div class="col-12 col-md-6 col-lg-4 photo-item">
                    <div class="js-dropzone border rounded p-2 d-flex align-items-center gap-2" style="min-height:90px; cursor:pointer;">
                      <img
                        class="js-preview"
                        src="{% if photoForm.vars.value and photoForm.vars.value.source %}{{ asset('uploads/services/' ~ photoForm.vars.value.source) }}{% else %}{{ asset('placeholder-image.png') }}{% endif %}"
                        data-placeholder="{{ asset('placeholder-image.png') }}"
                        alt=""
                        aria-hidden="true"
                        style="width:72px;height:72px;object-fit:cover;border-radius:10px;"
                      >
                      <div class="flex-grow-1 small">
                        <div class="fw-semibold">Déposez une image, ou cliquez.</div>
                        <div class="text-muted">JPEG/PNG/WEBP — 4&nbsp;Mo max</div>
                        <div class="js-filename mt-1"></div>
                        <div class="mt-2 d-flex gap-2 align-items-center">
                          <button type="button" class="btn btn-outline-secondary btn-sm js-add">Ajouter</button>
                          <button type="button" class="btn btn-outline-danger btn-sm remove-photo-btn">Supprimer la photo</button>
                        </div>
                      </div>
                      {{ form_widget(photoForm.file, {
                        attr: {
                          accept: 'image/*',
                          class: 'js-file',
                          style: 'position:absolute;left:-9999px;width:1px;height:1px;opacity:0;',
                          'data-max': 4194304
                        }
                      }) }}
                    </div>
                    <div class="mt-2">
                      <label class="form-label mb-1 small">Description</label>
                      {{ form_widget(photoForm.description, {
                        attr: { class:'form-control form-control-sm', placeholder:'Description (optionnelle)' }
                      }) }}
                      {{ form_errors(photoForm.file) }}
                    </div>
                  </div>
                {% endfor %}
              </div>
            </div>

          </div>
        </div>
      {% endfor %}
    </div>
  </div>

  <button class="btn btn-primary mt-3">Enregistrer</button>
  {{ form_end(form) }}
</div>

{# ===================== JS (DÉLÉGATION GÉNÉRIQUE) ===================== #}
<script>
document.addEventListener('DOMContentLoaded', () => {
  // Bloque le drag&drop global (évite l'ouverture du fichier dans l'onglet)
  ['dragenter','dragover','dragleave','drop'].forEach(ev => {
    document.addEventListener(ev, e => { e.preventDefault(); e.stopPropagation(); }, { passive:false });
  });

  // Helpers — récupère les éléments d'une dropzone
  function partsFrom(zone) {
    return {
      zone,
      input: zone.querySelector('input.js-file'),
      img: zone.querySelector('.js-preview'),
      nameEl: zone.querySelector('.js-filename'),
      removeCb: zone.querySelector('.js-remove-checkbox')
    };
  }

  // Ajoute un bloc depuis un prototype
  function addFromPrototype(col) {
    const index = parseInt(col.dataset.index || '0', 10);
    const protoName = col.dataset.protoname || '__name__';
    const re = new RegExp(protoName, 'g');
    const proto = col.dataset.prototype.replace(re, index);
    col.dataset.index = index + 1;

    const tmp = document.createElement('div');
    tmp.innerHTML = proto.trim();
    const node = tmp.firstElementChild;
    col.appendChild(node);
  }

  // ================== CLICS ==================
  document.addEventListener('click', (e) => {
    // Supprimer une photo
    const rmPhotoBtn = e.target.closest('.remove-photo-btn');
    if (rmPhotoBtn) {
      e.preventDefault();
      rmPhotoBtn.closest('.photo-item')?.remove();
      return;
    }

    // Supprimer un service
    const rmServiceBtn = e.target.closest('.remove-service-btn');
    if (rmServiceBtn) {
      e.preventDefault();
      rmServiceBtn.closest('.service-item')?.remove();
      return;
    }

    // Bouton "Ajouter" (ouvre le file picker associé)
    const addBtn = e.target.closest('.js-add');
    if (addBtn) {
      e.preventDefault();
      const zone = addBtn.closest('.photo-item')?.querySelector('.js-dropzone') || addBtn.closest('.js-dropzone');
      const p = partsFrom(zone);
      if (p.input) p.input.click();
      return;
    }

    // Clic sur une dropzone (hors éléments interactifs) => ouvre le file picker
    const zoneClick = e.target.closest('.js-dropzone');
    if (zoneClick) {
      if (e.target.closest('button, .btn, input, textarea, select, label, a')) return;
      const p = partsFrom(zoneClick);
      if (p.input) p.input.click();
      return;
    }

    // Bouton "+ Ajouter une photo"
    const addPhotoBtn = e.target.closest('.add-photo-btn');
    if (addPhotoBtn) {
      e.preventDefault();
      const photosCol = addPhotoBtn.closest('.service-item')?.querySelector('.photos-collection');
      if (photosCol) addFromPrototype(photosCol);
      return;
    }

    // Bouton "Ajouter un service"
    const addServiceBtn = e.target.closest('#add-service-btn');
    if (addServiceBtn) {
      e.preventDefault();
      const servicesCol = document.getElementById('services-collection');
      if (servicesCol) addFromPrototype(servicesCol);
      return;
    }

    // Effacer la sélection (profil/logo)
    const clearBtn = e.target.closest('.js-clear');
    if (clearBtn) {
      e.preventDefault();
      const zone = clearBtn.closest('.js-dropzone');
      if (!zone) return;
      const { input, img, nameEl, removeCb } = partsFrom(zone);
      if (input) input.value = '';
      if (img) {
        const ph = img.getAttribute('data-placeholder');
        if (ph) img.src = ph;
      }
      if (nameEl) nameEl.textContent = '';
      if (removeCb) removeCb.checked = false;
      return;
    }
  });

  // ================== CHANGEMENTS ==================
  document.addEventListener('change', (e) => {
    // Fichier choisi
    const fileInput = e.target.closest('input.js-file');
    if (fileInput) {
      const zone = fileInput.closest('.js-dropzone');
      if (!zone) return;
      const { img, nameEl, removeCb } = partsFrom(zone);

      const file = fileInput.files && fileInput.files[0];
      if (!file) return;

      const max = parseInt(fileInput.dataset.max || '4194304', 10);
      if (!file.type || !file.type.startsWith('image/')) { alert('Fichier non valide.'); fileInput.value=''; return; }
      if (file.size > max) { alert('Image trop lourde (max 4 Mo).'); fileInput.value=''; return; }

      const url = URL.createObjectURL(file);
      if (img) {
        img.onload = () => URL.revokeObjectURL(url);
        img.src = url;
      }
      if (nameEl) nameEl.textContent = 'Sélectionné : ' + (file.name || 'image');
      if (removeCb) removeCb.checked = false;
      return;
    }

    // Case "supprimer l'image actuelle"
    const rmCb = e.target.closest('.js-remove-checkbox');
    if (rmCb) {
      const zone = rmCb.closest('.js-dropzone');
      if (!zone) return;
      const { input, img, nameEl } = partsFrom(zone);
      if (rmCb.checked) {
        if (input) input.value = '';
        if (img) {
          const ph = img.getAttribute('data-placeholder');
          if (ph) img.src = ph;
        }
        if (nameEl) nameEl.textContent = '';
      }
      return;
    }
  });

  // ================== D&D VISUEL ==================
  document.addEventListener('dragover', (e) => {
    const zone = e.target.closest('.js-dropzone');
    if (zone) zone.classList.add('border-primary','bg-light');
  });
  document.addEventListener('dragleave', (e) => {
    const zone = e.target.closest('.js-dropzone');
    if (zone) zone.classList.remove('border-primary','bg-light');
  });
  document.addEventListener('drop', (e) => {
    const zone = e.target.closest('.js-dropzone');
    if (!zone) return;
    zone.classList.remove('border-primary','bg-light');

    const { input, img, nameEl, removeCb } = partsFrom(zone);
    if (!input || !img) return;

    const file = e.dataTransfer && e.dataTransfer.files && e.dataTransfer.files[0];
    if (!file) return;

    const max = parseInt(input.dataset.max || '4194304', 10);
    if (!file.type || !file.type.startsWith('image/')) { alert('Fichier non valide.'); return; }
    if (file.size > max) { alert('Image trop lourde (max 4 Mo).'); return; }

    const dt = new DataTransfer();
    dt.items.add(file);
    input.files = dt.files;

    const url = URL.createObjectURL(file);
    img.onload = () => URL.revokeObjectURL(url);
    img.src = url;
    if (nameEl) nameEl.textContent = 'Sélectionné : ' + (file.name || 'image');
    if (removeCb) removeCb.checked = false;
  });
});
</script>
{% endblock %}
