{# templates/home/_partials_service_photo.html.twig #}
<section class="container-fluid my-4">
  {% set servicesBase = upload_url_services|default('uploads/services') %}
  {% set list = services is defined ? services : (admin is defined and admin ? admin.services : []) %}

  {% if list is empty %}
    <div class="text-center text-muted py-4">
      Aucun service à afficher pour le moment.
    </div>
  {% else %}
    <div class="row g-4">
      {% for service in list %}
        {% set sid = (attribute(service, 'id') is defined and service.id) ? service.id : loop.index0 %}
        {% set cid = 'svcCarousel-' ~ sid %}

        {# Photos normalisées ou entités #}
        {% set photos = [] %}
        {% if attribute(service, 'photoServices') is defined %}
          {% set photos = service.photoServices %}
        {% elseif attribute(service, 'getPhotoServices') is defined %}
          {% set photos = service.getPhotoServices() %}
        {% endif %}

        <div class="col-12 col-md-6 col-lg-4">
          <div class="card h-100 shadow-sm">
            <div class="card-body">

              {# ✅ Titre visuel (évite h4/h5 si tu veux Lighthouse clean) #}
              <p class="h4 card-title supInfo mb-3">
                {{ attribute(service, 'libelle') is defined ? service.libelle : service.getLibelle() }}
              </p>

              {% if photos is empty %}
                <div class="text-muted">Aucune photo pour ce service.</div>
              {% else %}

                <div class="no-zoom-zone">
                  <div id="{{ cid }}" class="carousel slide svc-carousel" data-bs-ride="false">
                    <div class="carousel-inner service-lightbox-trigger" role="button" tabindex="0" aria-label="Ouvrir la galerie en grand">

                      {% for p in photos %}
                        {% set src = attribute(p, 'source') is defined ? p.source : p.getSource() %}
                        {% set desc = attribute(p, 'description') is defined ? p.description : (attribute(p, 'getDescription') is defined ? p.getDescription() : '') %}
                        {% set full = asset(servicesBase ~ '/' ~ src) %}
                        {% set smallSrc = src %}
                        {% set midSrc = src %}
                        {% if '-1280x720.' in src %}
                          {% set smallSrc = src|replace({'-1280x720.': '-640x360.'}) %}
                          {% set midSrc = src|replace({'-1280x720.': '-960x540.'}) %}
                        {% endif %}
                        {% set small = asset(servicesBase ~ '/' ~ smallSrc) %}
                        {% set mid = asset(servicesBase ~ '/' ~ midSrc) %}

                        <div class="carousel-item {{ loop.first ? 'active' : '' }}">
                          {# ✅ PAS de <a href="...image"> sinon mobile ouvre l'image brute #}
                          <img
                            src="{{ small }}"
                            srcset="{{ small }} 640w, {{ mid }} 960w, {{ full }} 1280w"
                            sizes="(min-width: 992px) 33vw, (min-width: 768px) 50vw, 100vw"
                            data-full="{{ full }}"
                            class="d-block w-100"
                            alt="{{ desc|default('Photo')|e }}"
                            loading="{{ loop.first ? 'eager' : 'lazy' }}"
                            decoding="async"
                            {% if loop.first %}fetchpriority="high"{% endif %}
                            style="max-height: 320px; object-fit: contain; background-color: #f8f9fa;"
                          >

                          {% if desc %}
                            <div class="carousel-caption d-none d-md-block bg-dark bg-opacity-50 rounded p-2">
                              {{ desc }}
                            </div>
                          {% endif %}
                        </div>
                      {% endfor %}

                    </div>

                    <button class="carousel-control-prev" type="button" data-bs-target="#{{ cid }}" data-bs-slide="prev" aria-label="Précédent">
                      <span class="carousel-control-prev-icon" aria-hidden="true"></span>
                    </button>
                    <button class="carousel-control-next" type="button" data-bs-target="#{{ cid }}" data-bs-slide="next" aria-label="Suivant">
                      <span class="carousel-control-next-icon" aria-hidden="true"></span>
                    </button>
                  </div>
                </div>

              {% endif %}
            </div>
          </div>
        </div>
      {% endfor %}
    </div>
  {% endif %}
</section>

{# ✅ Modal attendu par ton JS #}
<div class="modal fade" id="lightboxModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered modal-xl">
    <div class="modal-content">
      <div class="modal-header">
        <p class="modal-title h5 mb-0">Galerie</p>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fermer"></button>
      </div>

      <div class="modal-body p-0">
        <div id="lightboxCarousel" class="carousel slide svc-carousel svc-carousel--modal" data-bs-interval="false">
          <div class="carousel-indicators"></div>
          <div class="carousel-inner"></div>

          <button class="carousel-control-prev" type="button" data-bs-target="#lightboxCarousel" data-bs-slide="prev" aria-label="Précédent">
            <span class="carousel-control-prev-icon" aria-hidden="true"></span>
          </button>
          <button class="carousel-control-next" type="button" data-bs-target="#lightboxCarousel" data-bs-slide="next" aria-label="Suivant">
            <span class="carousel-control-next-icon" aria-hidden="true"></span>
          </button>
        </div>
      </div>

      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fermer</button>
      </div>
    </div>
  </div>
</div>
