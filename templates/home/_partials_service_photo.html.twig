{# Section Services + Lightbox. 
   Attend un tableau "services" normalisé (id, libelle, photoServices[{source, description}]).
   Fallback : si "services" manquant, on tente admin.services (entités), sinon message vide.
#}

<section class="container-fluid my-4">
  {% set servicesBase = upload_url_services|default('uploads/services') %}
  {% set list = services is defined ? services : (admin is defined and admin ? admin.services : []) %}

  {% if list is empty %}
    <div class="text-center text-muted py-4">
      Aucun service à afficher pour le moment.
    </div>
  {% else %}
    <div class="row g-4">
      {% for service in list %}
        {% set cid = 'svcCarousel-' ~ (attribute(service, 'id') is defined and service.id ? service.id : loop.index0) %}

        <div class="col-12 col-sm-6 col-lg-4 col-xl-3">
          <div class="card h-100">
            <div class="card-body py-3">
              <h2 class="h5 mb-0 text-center">
                {{ attribute(service, 'libelle') ?? 'Service '  }}
              </h2>
            </div>

            {% set photos = attribute(service, 'photoServices') ?? [] %}
            {% if photos|length > 0 %}
              <div id="{{ cid }}" class="carousel slide service-lightbox-trigger" data-bs-ride="carousel" style="cursor:zoom-in;">

                {% if photos|length > 1 %}
                  <div class="carousel-indicators">
                    {% for p in photos %}
                      <button
                        type="button"
                        data-bs-target="#{{ cid }}"
                        data-bs-slide-to="{{ loop.index0 }}"
                        class="{{ loop.first ? 'active' }}"
                        {% if loop.first %} aria-current="true" {% endif %}
                        aria-label="Slide {{ loop.index }}">
                      </button>
                    {% endfor %}
                  </div>
                {% endif %}

                <div class="carousel-inner">
                  {% for photo in photos %}
                    {# --- Calcul des différentes tailles et fallback --- #}
                    {% set srcName = attribute(photo, 'source') %}
                    {% if srcName %}
                      {# Nouveau système : fichiers suffixés -car-sm / -car-md / -car-lg #}
                      {% if '-car-md.' in srcName %}
                        {% set srcSmName = srcName|replace({'-car-md.':'-car-sm.'}) %}
                        {% set srcMdName = srcName %}
                        {% set srcLgName = srcName|replace({'-car-md.':'-car-lg.'}) %}
                      {% else %}
                        {# Anciennes images : on réutilise le même fichier pour toutes les tailles #}
                        {% set srcSmName = srcName %}
                        {% set srcMdName = srcName %}
                        {% set srcLgName = srcName %}
                      {% endif %}

                      {% set srcSm = asset(servicesBase ~ '/' ~ srcSmName) %}
                      {% set srcMd = asset(servicesBase ~ '/' ~ srcMdName) %}
                      {% set srcLg = asset(servicesBase ~ '/' ~ srcLgName) %}
                    {% else %}
                      {% set srcSm = asset('placeholder-image.png') %}
                      {% set srcMd = srcSm %}
                      {% set srcLg = srcSm %}
                    {% endif %}

                    <div class="carousel-item {{ loop.first ? 'active' }}">
                      <div class="ratio ratio-16x9">
                        <img
                          src="{{ srcMd }}"
                          srcset="{{ srcSm }} 640w, {{ srcMd }} 1280w, {{ srcLg }} 1920w"
                          sizes="(max-width: 575px) 100vw, (max-width: 991px) 50vw, 25vw"
                          data-full="{{ srcLg }}"
                          alt="{{ attribute(photo, 'description') ?? ('Photo ' ~ loop.index ~ ' - ' ~ (attribute(service,'libelle') ?? 'Service')) }}"
                          class="w-100 h-100"
                          style="object-fit:cover;"
                          loading="{{ loop.first ? 'eager' : 'lazy' }}"
                        >
                      </div>

                      {% if attribute(photo, 'description') %}
                        <div class="carousel-caption d-none d-md-block bg-dark bg-opacity-50 rounded p-2">
                          <h5 class="mb-1">{{ attribute(service, 'libelle') ?? 'Service' }}</h5>
                          <p class="mb-0">{{ photo.description }}</p>
                        </div>
                      {% endif %}
                    </div>
                  {% endfor %}
                </div>

                {% if photos|length > 1 %}
                  <button class="carousel-control-prev" type="button" data-bs-target="#{{ cid }}" data-bs-slide="prev">
                    <span class="carousel-control-prev-icon" aria-hidden="true"></span>
                    <span class="visually-hidden">Précédent</span>
                  </button>
                  <button class="carousel-control-next" type="button" data-bs-target="#{{ cid }}" data-bs-slide="next">
                    <span class="carousel-control-next-icon" aria-hidden="true"></span>
                    <span class="visually-hidden">Suivant</span>
                  </button>
                {% endif %}
              </div>
            {% else %}
              <p class="text-muted px-3 pb-3">Aucune photo pour ce service.</p>
            {% endif %}
          </div>
        </div>
      {% endfor %}
    </div>
  {% endif %}
</section>

{# Modal Lightbox (une seule fois par page) #}
<div class="modal fade" id="lightboxModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered modal-xl">
    <div class="modal-content bg-dark">
      <div class="modal-body p-0 position-relative">
        <button type="button" class="btn-close btn-close-white position-absolute top-0 end-0 m-3" data-bs-dismiss="modal" aria-label="Fermer"></button>

        <div id="lightboxCarousel" class="carousel slide" data-bs-interval="false">
          <div class="carousel-indicators"></div>
          <div class="carousel-inner"></div>

          <button class="carousel-control-prev" type="button" data-bs-target="#lightboxCarousel" data-bs-slide="prev" style="filter: invert(1);">
            <span class="carousel-control-prev-icon" aria-hidden="true"></span>
            <span class="visually-hidden">Précédent</span>
          </button>
          <button class="carousel-control-next" type="button" data-bs-target="#lightboxCarousel" data-bs-slide="next" style="filter: invert(1);">
            <span class="carousel-control-next-icon" aria-hidden="true"></span>
            <span class="visually-hidden">Suivant</span>
          </button>
        </div>
      </div>
    </div>
  </div>
</div>
